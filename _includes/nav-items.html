<div class="nav-items">
  {% comment %} Build collections {% endcomment %}
  {%- assign story_pages = site.pages | where: "type", "story" -%}
  {%- assign lines = story_pages | map: "line" | uniq | sort -%}
  {%- assign line_labels = site.data.line_labels -%}
  {%- assign codex_pages = site.pages | where: "type", "codex" | sort: "order" -%}

  <ul class="nav-menu">
    {%- if lines.size > 0 -%}
    <li class="menu-item has-submenu">
      <a class="nav-link" href="{{ '/stories/' | relative_url }}">Stories</a>
      <ul class="submenu">
        {%- for ln in lines -%}
          {%- assign pages_in_line = story_pages | where: "line", ln | sort: "timeline" -%}
          {%- if pages_in_line.size > 0 -%}
            {%- assign label = line_labels[ln] | default: ln | capitalize -%}
            <li class="submenu-item has-submenu">
              <span class="nav-link">{{ label }}<span class="chevron">â€º</span></span>
              <ul class="subsubmenu">
                {%- for page in pages_in_line -%}
                  {%- if page.title -%}
                    {%- assign yr = page.timeline | date: '%Y' -%}
                    <li><a class="nav-item" href="{{ page.url | relative_url }}">{{ page.title | escape }}{% if yr %} ({{ yr }}){% endif %}</a></li>
                  {%- endif -%}
                {%- endfor -%}
              </ul>
            </li>
          {%- endif -%}
        {%- endfor -%}
      </ul>
    </li>
    {%- endif -%}

    {%- if codex_pages.size > 0 -%}
    <li class="menu-item has-submenu">
      <a class="nav-link" href="{{ '/codex/' | relative_url }}">Codex</a>
      <ul class="submenu">
        {%- for page in codex_pages -%}
          {%- if page.title -%}
            <li><a class="nav-item" href="{{ page.url | relative_url }}">{{ page.title | escape }}</a></li>
          {%- endif -%}
        {%- endfor -%}
      </ul>
    </li>
    {%- endif -%}
  </ul>
</div>
